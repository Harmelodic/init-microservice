name: main

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  maven:
    permissions:
      contents: 'read'
      id-token: 'write'
    uses: Harmelodic/github-workflows/.github/workflows/build-java-container-gcp.yml@main
    with:
      maven_options: >
        --define image.repository=europe-north1-docker.pkg.dev/personal-artifacts-353012/harmelodic/init-microservice
        --define image.tag=${GITHUB_SHA:-latest}
        --define pact.verifier.publishResults=true
        --define pact.broker.url=https://pact.harmelodic.com
        --define pact.broker.username=pact-broker-user
        --define pact.broker.password=${{ secrets.PACT_BROKER_PASSWORD }}
      google_docker_registry: europe-north1-docker.pkg.dev
      service_account: automation@automation-220928.iam.gserviceaccount.com
      workload_identity_provider: projects/401363556022/locations/global/workloadIdentityPools/automation/providers/github
    # ^ For publishing Consumer PACTs
    env:
      PACTBROKER_AUTH_USERNAME: pact-broker-user # For publishing Provider results
      PACTBROKER_AUTH_PASSWORD: ${{ secrets.PACT_BROKER_PASSWORD }} # For publishing Provider results

  terraform:
    permissions:
      contents: 'read'
      id-token: 'write'
    uses: Harmelodic/github-workflows/.github/workflows/validate-terraform-gcp.yml@main
    with:
      workload_identity_provider: projects/401363556022/locations/global/workloadIdentityPools/automation/providers/github
      service_account: automation@automation-220928.iam.gserviceaccount.com
